#!/usr/bin/env python
import configparser
import feedparser
import urllib
import re
import time
import sys
import threading
from twitter import *

og_image_pattern = re.compile('.*og:image" content="(.*)".*')


class Feed:
    def __init__(self, config, section):
        self.feed_url = config.get(section, 'feed_url')
        self.num_last_tweets = config.getint(section, 'num_last_tweets')
        self.intervals_between_tweets_in_seconds = config.getint(section, 'intervals_between_tweets_in_seconds')
        self.attach_featured_images = config.getboolean(section, 'attach_featured_images')
        self.oauth_token = config.get(section, 'oauth_token')
        self.oauth_token_secret = config.get(section, 'oauth_token_secret')
        self.oauth_consumer_key = config.get(section, 'oauth_consumer_key')
        self.oauth_consumer_secret = config.get(section, 'oauth_consumer_secret')

    def __str__(self):
        return str(self.__dict__)

    def get_oauth(self):
        return OAuth(self.oauth_token,
                     self.oauth_token_secret,
                     self.oauth_consumer_key,
                     self.oauth_consumer_secret)

    def tweet_last_posts(self):
        t = Twitter(auth=self.get_oauth())
        t_upload = Twitter(auth=self.get_oauth(), domain='upload.twitter.com')

        feed_dict = feedparser.parse(self.feed_url)

        for i in xrange(self.num_last_tweets):
            entry = feed_dict.entries[i]

            if self.attach_featured_images:
                Feed.scrape_entry_og_image(entry)

                if entry.featured_image_url is not None:
                    img_data = Feed.download_image(entry.featured_image_url)
                    img_id = t_upload.media.upload(media=img_data)["media_id_string"]
                    t.statuses.update(status=entry.title + " " + entry.link, media_ids = img_id)
            else:
                t.statuses.update(status=entry.title + " " + entry.link)

            if self.intervals_between_tweets_in_seconds > 0:
                time.sleep(self.intervals_between_tweets_in_seconds)

    @staticmethod
    def scrape_entry_og_image(entry):
        '''Download a feed's entry HTML and parse it to find the og:image in the entry if available.'''
        entry.featured_image_url = None
        f = urllib.urlopen(entry.link)
        html = f.read()
        f.close()
        match = og_image_pattern.search(html)
        if match is not None:
            entry.featured_image_url = match.group(1)
        return entry.featured_image_url is not None

    @staticmethod
    def download_image(img_url):
        file_path = "image.tmp"
        urllib.urlretrieve(img_url, file_path)
        f = open(file_path,'rb')
        img_data = f.read()
        f.close()
        return img_data


def load_config(configFile='config.conf'):
    '''Returns a configparser object that contains all the configuration for the different blogs and twitter accounts.'''
    config = configparser.ConfigParser()
    config.read(configFile)
    return config


if __name__ == '__main__':
    if len(sys.argv) < 2:
        print "Error: config file path not passed.\n"
        sys.exit(1)
        
    config = load_config(sys.argv[1])
    for section_name in config.sections():
        feed = Feed(config, section_name)
        t = threading.Thread(target=feed.tweet_last_posts)
        t.daemon = False
        t.start()
